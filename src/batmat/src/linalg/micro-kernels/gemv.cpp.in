#ifdef __clang__
#pragma clang fp contract(fast)
#endif

#include <batmat/linalg/micro-kernels/gemv.tpp>

// clang-format off
namespace batmat::linalg::micro_kernels::gemv::@DType@_@VL@_@Negate@ {
using DType = @DType@;
using Abi   = datapar::deduced_abi<DType, @VL@>;
static constexpr bool Negate = @Negate@;
// clang-format on

using enum StorageOrder;
using enum MatrixStructure;

template <StorageOrder O>
using CStorageOrder = std::integral_constant<StorageOrder, O>;
template <MatrixStructure O>
using CMatrixStructure = std::integral_constant<MatrixStructure, O>;

constexpr std::array ColRowMajor{ColMajor, RowMajor};
constexpr std::array Triangular{LowerTriangular, UpperTriangular};

namespace {
template <auto V>
const auto wrap = V;
} // namespace

extern const auto gemv_copy_register_inst_gemv =
    guanaqo::make_lut<ColRowMajor>([]<auto OA>(CStorageOrder<OA>) -> const void * {
        constexpr KernelConfig Conf{.negate = Negate};
        return &wrap<gemv_copy_register<DType, Abi, Conf, OA>>;
    });
extern const auto gemv_copy_register_inst_gemv_sA =
    guanaqo::make_lut<ColRowMajor, 2>([]<auto OA>(CStorageOrder<OA>, auto S) -> const void * {
        constexpr KernelConfig Conf{.negate = Negate, .shift_A = S ? 1 : -1};
        return &wrap<gemv_copy_register<DType, Abi, Conf, OA>>;
    });
extern const auto gemv_copy_register_inst_gemv_sB =
    guanaqo::make_lut<ColRowMajor, 2>([]<auto OA>(CStorageOrder<OA>, auto S) -> const void * {
        constexpr KernelConfig Conf{.negate = Negate, .shift_B = S ? 1 : -1};
        return &wrap<gemv_copy_register<DType, Abi, Conf, OA>>;
    });
extern const auto gemv_copy_register_inst_gemv_sC = guanaqo::make_lut<ColRowMajor, 2, 2>(
    []<auto OA>(CStorageOrder<OA>, auto S, auto M) -> const void * {
        constexpr int sC = S ? 1 : -1;
        constexpr KernelConfig Conf{
            .negate = Negate, .rotate_C = sC, .rotate_D = sC, .mask_D = M ? sC : 0};
        return &wrap<gemv_copy_register<DType, Abi, Conf, OA>>;
    });

} // namespace batmat::linalg::micro_kernels::gemv
