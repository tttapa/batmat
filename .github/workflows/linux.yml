name: 'CI: Linux'
on:
  workflow_dispatch:
  push:

jobs:
  build:
    name: "Build (GCC ${{ matrix.gcc }}, ${{ matrix.build_type }}, ${{ matrix.profile }}, ${{ matrix.gsi-hpc-simd == 'True' && 'GSI-HPC/SIMD' || 'GCC SIMD' }})"
    strategy:
      matrix:
        gcc: ["15"]
        build_type: ["Debug"]
        profile: ["laptop"]
        gsi-hpc-simd: ["True", "False"]
      fail-fast: false
    runs-on: ubuntu-24.04
    env:
      CTEST_OUTPUT_ON_FAILURE: "1"
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Conan and sccache
      uses: ./.github/workflows/setup-conan
      with:
        cache-key: ${{ matrix.profile }}-${{ matrix.gcc }}-${{ matrix.build_type }}-${{ matrix.gsi-hpc-simd }}

    - name: Build
      run: >
        conan build . --build=missing -pr scripts/dev/profiles/${{ matrix.profile }}
        -s compiler.version=${{ matrix.gcc }}
        -s build_type=${{ matrix.build_type }}
        -c \*:tools.build:skip_test=True
        -c \&:tools.build:skip_test=False
        -o \&:with_benchmarks=True
        -o \&:with_blasfeo=True
        -o \&:with_gsi_hpc_simd=${{ matrix.gsi-hpc-simd }}
        -c '&:tools.cmake.cmaketoolchain:extra_variables*={"CMAKE_C_COMPILER_LAUNCHER": "sccache"}'
        -c '&:tools.cmake.cmaketoolchain:extra_variables*={"CMAKE_CXX_COMPILER_LAUNCHER": "sccache"}'
        -c '&:tools.cmake.cmaketoolchain:extra_variables*={"CMAKE_DISABLE_PRECOMPILE_HEADERS": "On"}'
        -c '&:tools.cmake.cmaketoolchain:extra_variables*={"CMAKE_COMPILE_WARNING_AS_ERROR": "On"}'
        -c '&:tools.compilation:verbosity=verbose'

    - run: conan cache clean

  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Conan and sccache
        uses: ./.github/workflows/setup-conan
        with:
          cache-key: docs

      - name: Install Doxygen
        run: |
          set -euo pipefail
          DOXY_URL="https://github.com/doxygen/doxygen/releases/download/Release_1_16_1/doxygen-1.16.1.linux.bin.tar.gz"
          DOXY_SHA="a56f885d37e3aae08a99f638d17bbb381224c03a878d9e2dda4f9fa4baf1d8bd"
          curl -sL "$DOXY_URL" -o /tmp/doxygen-1.16.1.linux.bin.tar.gz
          echo "$DOXY_SHA  /tmp/doxygen-1.16.1.linux.bin.tar.gz" | sha256sum -c -
          sudo tar xzf /tmp/doxygen-1.16.1.linux.bin.tar.gz -C /usr/local/bin doxygen-1.16.1/bin/doxygen --strip-components=2

      - name: Install dependencies
        run: >
          conan install . --build=missing -pr scripts/dev/profiles/laptop
          -s:h build_type=Debug -s:b build_type=Release
          -s:b compiler.cppstd=20

      - name: Generate documentation
        run: ./scripts/ci/gen-docs.sh "${{ github.workspace }}/staging" conan-default conan-debug

      - name: Upload documentation
        uses: actions/upload-artifact@v6
        with:
          name: documentation
          path: staging

      - run: conan cache clean

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-24.04
    needs: docs
    permissions:
      contents: write
    concurrency:
      group: docs-${{ github.repository }}-gh-pages
      cancel-in-progress: false  # queue, donâ€™t cancel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Create a copy of the repo in /tmp/staging.
      # Create the `gh-pages` branch if it doesn't exist already, check it out.
      - name: Create staging area
        run: |
          rm -rf /tmp/staging
          cp -ar $GITHUB_WORKSPACE/ /tmp/staging
          git config --global --add safe.directory /tmp/staging
          cd /tmp/staging
          git fetch origin gh-pages:gh-pages ||:
          git checkout gh-pages || \
          { git checkout --orphan gh-pages && git rm -rf . && git clean -fxd ; }
          echo -e 'bib*.aux\ncitelist.doc*\n.conan2\nbuild\ntttapa-conan-recipes' > .gitignore

      - name: Clear old documentation
        run: ./scripts/ci/gen-docs.sh "/tmp/staging" clean

      - name: Download new documentation
        uses: actions/download-artifact@v7
        with:
          name: documentation
          path: /tmp/staging

      - name: Generate index
        run: ./scripts/ci/gen-docs-index.sh "/tmp/staging"

      # Commit the new documentation, squash the commits, and push it to GitHub
      - name: Commit and push documention
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          commithash=$(git rev-parse HEAD)
          cd /tmp/staging
          git add .
          git commit -m "Documentation for ${commithash}" && \
          git reset $(git commit-tree HEAD^{tree} -m "Documentation for ${commithash}") && \
          git push -f origin gh-pages ||:
